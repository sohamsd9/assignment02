<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Norah Jones">
<meta name="dcterms.date" content="2024-11-21">

<title>Assignment 02</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="assignment02-sohamsd9_files/libs/clipboard/clipboard.min.js"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/popper.min.js"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="assignment02-sohamsd9_files/libs/quarto-html/anchor.min.js"></script>
<link href="assignment02-sohamsd9_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="assignment02-sohamsd9_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="assignment02-sohamsd9_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="assignment02-sohamsd9_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="assignment02-sohamsd9_files/libs/bootstrap/bootstrap-32613036bc328a5d3e9537f7137c7266.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#start-a-spark-session" id="toc-start-a-spark-session" class="nav-link active" data-scroll-target="#start-a-spark-session"><span class="header-section-number">1</span> Start a Spark session</a></li>
  <li><a href="#load-the-csv-file-into-a-spark-dataframe" id="toc-load-the-csv-file-into-a-spark-dataframe" class="nav-link" data-scroll-target="#load-the-csv-file-into-a-spark-dataframe"><span class="header-section-number">2</span> Load the CSV file into a Spark DataFrame</a></li>
  <li><a href="#register-the-dataframe-as-a-temporary-sql-view" id="toc-register-the-dataframe-as-a-temporary-sql-view" class="nav-link" data-scroll-target="#register-the-dataframe-as-a-temporary-sql-view"><span class="header-section-number">3</span> Register the DataFrame as a temporary SQL view</a></li>
  <li><a href="#show-schema-and-sample-data" id="toc-show-schema-and-sample-data" class="nav-link" data-scroll-target="#show-schema-and-sample-data"><span class="header-section-number">4</span> Show Schema and Sample Data</a></li>
  <li><a href="#comment-the-lines-below-when-rendering-the-submission" id="toc-comment-the-lines-below-when-rendering-the-submission" class="nav-link" data-scroll-target="#comment-the-lines-below-when-rendering-the-submission"><span class="header-section-number">5</span> comment the lines below when rendering the submission</a></li>
  <li><a href="#create-output-directory-if-it-doesnt-exist" id="toc-create-output-directory-if-it-doesnt-exist" class="nav-link" data-scroll-target="#create-output-directory-if-it-doesnt-exist"><span class="header-section-number">6</span> Create output directory if it doesn’t exist</a>
  <ul class="collapse">
  <li><a href="#query-1-industry-specific-salary-trends-grouped-by-job-titl" id="toc-query-1-industry-specific-salary-trends-grouped-by-job-titl" class="nav-link" data-scroll-target="#query-1-industry-specific-salary-trends-grouped-by-job-titl"><span class="header-section-number">6.1</span> QUERY 1 Industry-Specific Salary Trends Grouped by Job Titl</a></li>
  </ul></li>
  <li><a href="#query-2-top-5-companies-with-the-most-remote-jobs-in-california" id="toc-query-2-top-5-companies-with-the-most-remote-jobs-in-california" class="nav-link" data-scroll-target="#query-2-top-5-companies-with-the-most-remote-jobs-in-california"><span class="header-section-number">7</span> QUERY 2 : Top 5 Companies with the Most Remote Jobs in California</a></li>
  <li><a href="#query-3-monthly-job-posting-trends-in-california" id="toc-query-3-monthly-job-posting-trends-in-california" class="nav-link" data-scroll-target="#query-3-monthly-job-posting-trends-in-california"><span class="header-section-number">8</span> Query 3 :Monthly Job Posting Trends in California</a></li>
  <li><a href="#add-parsed-date-year-month" id="toc-add-parsed-date-year-month" class="nav-link" data-scroll-target="#add-parsed-date-year-month"><span class="header-section-number">9</span> Add parsed date, year, month</a></li>
  <li><a href="#sql-query" id="toc-sql-query" class="nav-link" data-scroll-target="#sql-query"><span class="header-section-number">10</span> SQL Query</a></li>
  <li><a href="#convert-month-numbers-to-proper-labels-if-needed" id="toc-convert-month-numbers-to-proper-labels-if-needed" class="nav-link" data-scroll-target="#convert-month-numbers-to-proper-labels-if-needed"><span class="header-section-number">11</span> Convert month numbers to proper labels if needed</a></li>
  <li><a href="#query-4-salary-comparisons-across-major-us-cities" id="toc-query-4-salary-comparisons-across-major-us-cities" class="nav-link" data-scroll-target="#query-4-salary-comparisons-across-major-us-cities"><span class="header-section-number">12</span> Query 4 – Salary Comparisons Across Major US Cities</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assignment 02</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Norah Jones </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Boston University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 21, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">October 10, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>{python} from pyspark.sql import SparkSession import pandas as pd import seaborn as sns import matplotlib.pyplot as plt import os</p>
<section id="start-a-spark-session" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Start a Spark session</h1>
<p>spark = SparkSession.builder.appName(“JobPostingsAnalysis”).getOrCreate()</p>
</section>
<section id="load-the-csv-file-into-a-spark-dataframe" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Load the CSV file into a Spark DataFrame</h1>
<p>df = spark.read.option(“header”, “true”).option(“inferSchema”, “true”).option(“multiLine”,“true”).option(“escape”, “"”).csv(“lightcast_job_postings.csv”)</p>
</section>
<section id="register-the-dataframe-as-a-temporary-sql-view" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Register the DataFrame as a temporary SQL view</h1>
<p>df.createOrReplaceTempView(“job_postings”)</p>
</section>
<section id="show-schema-and-sample-data" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Show Schema and Sample Data</h1>
<p>print(“—This is Diagnostic check, No need to print it in the final doc—”)</p>
</section>
<section id="comment-the-lines-below-when-rendering-the-submission" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> comment the lines below when rendering the submission</h1>
<p>df.printSchema() df.show(5)</p>
</section>
<section id="create-output-directory-if-it-doesnt-exist" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Create output directory if it doesn’t exist</h1>
<p>if not os.path.exists(‘output’): os.makedirs(‘output’)</p>
<p>from pyspark.sql.functions import col, monotonically_increasing_id</p>
<p>industries_df = df.select( col(“naics_2022_6”), col(“naics_2022_6_name”), col(“soc_5”).alias(“soc_code”), col(“soc_5_name”).alias(“soc_name”), col(“lot_specialized_occupation_name”).alias(“specialized_occupation”), col(“lot_occupation_group”).alias(“occupation_group”) ).distinct().withColumn(“industry_id”, monotonically_increasing_id())</p>
<p>industries_df = industries_df.select( “industry_id”, “naics_2022_6”, “naics_2022_6_name”, “soc_code”, “soc_name”, “specialized_occupation”, “occupation_group” )</p>
<p>industries_df.show(5, truncate=False)</p>
<p>locations_df = df.select( col(“location”), col(“city_name”), col(“state_name”), col(“county_name”), col(“msa”), col(“msa_name”), ).distinct().withColumn(“location_id”, monotonically_increasing_id())</p>
<p>from pyspark.sql import SparkSession, functions as F from pyspark.sql.window import Window companies_df = df.select( col(“company”), col(“company_name”), col(“company_raw”), col(“company_is_staffing”), ).distinct().where(F.col(“company”).isNotNull()).where(F.col(“company_name”) != ‘Unclassified’).withColumn(“company_id”, monotonically_increasing_id()) company_df = companies_df.dropna()</p>
<p>from pyspark.sql.functions import lower job_postings_df = df.select( col(“ID”).alias(“job_postings_id”), “title_clean”,“employment_type_name”,“remote_type_name”,“remote_type”,“body”, “min_years_experience”,“max_years_experience”,“salary”,“salary_from”,“salary_to”, “posted”,“expired”,“duration”, “company”,“location”,“naics_2022_6” ).dropDuplicates([“job_postings_id”])<br>
.join(companies_df.select(“company”,“company_id”), on=“company”, how=“left”)<br>
.join(locations_df.select(“location”,“location_id”), on=“location”, how=“left”)<br>
.join(industries_df.select(“naics_2022_6”,“industry_id”), on=“naics_2022_6”, how=“left”)</p>
<p>companies_df.createOrReplaceTempView(“companies”) industries_df.createOrReplaceTempView(“industries”) locations_df.createOrReplaceTempView(“locations”) job_postings_df.createOrReplaceTempView(“job_postings”)</p>
<section id="query-1-industry-specific-salary-trends-grouped-by-job-titl" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="query-1-industry-specific-salary-trends-grouped-by-job-titl"><span class="header-section-number">6.1</span> QUERY 1 Industry-Specific Salary Trends Grouped by Job Titl</h2>
<p>tech_salary_trends = spark.sql(““” SELECT i.naics_2022_6_name AS industry_name, i.specialized_occupation, PERCENTILE_APPROX(j.salary, 0.5) AS median_salary FROM job_postings j JOIN industries i ON j.naics_2022_6 = i.naics_2022_6 WHERE i.naics_2022_6 = 518210 AND j.salary IS NOT NULL AND j.salary &gt; 0 GROUP BY i.naics_2022_6_name, i.specialized_occupation ORDER BY median_salary DESC “““)</p>
<p>tech_salary_pd = tech_salary_trends.toPandas()</p>
<p>plt.figure(figsize=(12, 6)) ax = sns.barplot(data=tech_salary_pd, x=“median_salary”, y=“specialized_occupation”, palette=“viridis”, hue=“specialized_occupation”, legend=False) ax.set_xlabel(“Median Salary”) ax.set_ylabel(“Specialized Occupation”) ax.set_title(“Median Salary by Specialized Occupation (NAICS 518210)”) plt.tight_layout() plt.savefig(‘output/tech_salary_trends.png’) plt.show()</p>
</section>
</section>
<section id="query-2-top-5-companies-with-the-most-remote-jobs-in-california" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> QUERY 2 : Top 5 Companies with the Most Remote Jobs in California</h1>
<p>remote_jobs_ca = spark.sql(““” SELECT COALESCE(c.company_name) AS company_name, COUNT(*) AS remote_jobs FROM job_postings j JOIN companies c ON j.company_id = c.company_id JOIN locations l ON j.location_id = l.location_id WHERE (j.remote_type = 1 OR LOWER(j.remote_type_name) LIKE ‘remote%’) AND l.state_name = ‘California’ GROUP BY COALESCE(c.company_name) ORDER BY remote_jobs DESC LIMIT 10 “““)</p>
<p>remote_jobs_ca_pd = remote_jobs_ca.toPandas()</p>
<p>remote_jobs_ca_pd.head()</p>
<p>plt.figure(figsize=(10, 6)) sns.barplot(x=“remote_jobs”, y=“company_name”, data=remote_jobs_ca_pd, palette=“viridis”, hue=“company_name”, legend=False) plt.title(“Top 10 Companies Hiring Remote Jobs in California”) plt.xlabel(“Number of Remote Jobs”) plt.ylabel(“Company”) plt.tight_layout() plt.savefig(‘output/remote_jobs_ca.png’) plt.show()</p>
</section>
<section id="query-3-monthly-job-posting-trends-in-california" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Query 3 :Monthly Job Posting Trends in California</h1>
<p>from pyspark.sql.functions import to_date, year, month</p>
</section>
<section id="add-parsed-date-year-month" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Add parsed date, year, month</h1>
<p>job_postings_with_date = job_postings_df.withColumn( “posted_date”, to_date(“posted”, “yyyy-MM-dd”) ).withColumn( “year”, year(“posted_date”) ).withColumn( “month”, month(“posted_date”) )</p>
<p>job_postings_with_date.createOrReplaceTempView(“job_postings_with_date”) locations_df.createOrReplaceTempView(“locations”)</p>
</section>
<section id="sql-query" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> SQL Query</h1>
<p>monthly_trends_ca = spark.sql(““” SELECT j.year, j.month, COUNT(*) AS job_count FROM job_postings_with_date j JOIN locations l ON j.location_id = l.location_id WHERE l.state_name = ‘California’ AND j.posted_date IS NOT NULL GROUP BY j.year, j.month ORDER BY j.year, j.month “““)</p>
<p>monthly_trends_ca.show(10)</p>
<p>monthly_trends_ca_pd = monthly_trends_ca.toPandas()</p>
</section>
<section id="convert-month-numbers-to-proper-labels-if-needed" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Convert month numbers to proper labels if needed</h1>
<p>monthly_trends_ca_pd[“month”] = monthly_trends_ca_pd[“month”].astype(int)</p>
<p>plt.figure(figsize=(12, 6)) sns.lineplot(data=monthly_trends_ca_pd, x=“month”, y=“job_count”, hue=“year”, marker=‘o’) plt.title(“Monthly Job Posting Trends in California”) plt.xlabel(“Month”) plt.ylabel(“Number of Job Postings”) plt.legend(title=“Year”) plt.grid(True) plt.savefig(‘output/monthly_trends_ca.png’) plt.show()</p>
</section>
<section id="query-4-salary-comparisons-across-major-us-cities" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Query 4 – Salary Comparisons Across Major US Cities</h1>
<p>msa_list = [14460,47900,35620,41860,42660,31080,19100,26420,12420,34980,28140,19740] salary_comparison_cities = spark.sql(f”“” WITH base AS ( SELECT l.MSA, l.MSA_NAME, j.SALARY FROM job_postings j JOIN locations l ON j.LOCATION_ID = l.LOCATION_ID WHERE j.SALARY IS NOT NULL AND j.SALARY &gt; 0 AND l.MSA IN ({“,”.join(map(str, msa_list))}) ), named AS ( SELECT CASE CAST(MSA AS INT) WHEN 14460 THEN ‘Boston’ WHEN 47900 THEN ‘Washington DC’ WHEN 35620 THEN ‘New York’ WHEN 41860 THEN ‘San Francisco’ WHEN 42660 THEN ‘Seattle’ WHEN 31080 THEN ‘Los Angeles’ WHEN 19100 THEN ‘Dallas’ WHEN 26420 THEN ‘Houston’ WHEN 12420 THEN ‘Austin’ WHEN 34980 THEN ‘Nashville’ WHEN 28140 THEN ‘Kansas City’ WHEN 19740 THEN ‘Denver’ ELSE COALESCE(MSA_NAME,‘Unknown’) END AS metro, SALARY FROM base ) SELECT metro, ROUND(AVG(SALARY), 2) AS average_salary, COUNT(*) AS job_count FROM named GROUP BY metro ORDER BY average_salary DESC “““)</p>
<p>salary_comparison_cities.show()</p>
<p>salary_comparison_cities_pd = salary_comparison_cities.toPandas()</p>
<p>plt.figure(figsize=(12, 8)) sns.barplot( data=salary_comparison_cities_pd, x=“average_salary”, y=“metro”, palette=“viridis”, hue=“metro”, # Set hue to the y-axis variable legend=False # Hide the legend ) plt.title(“Average Salary Comparison Across Major US Metro Areas”) plt.xlabel(“Average Salary”) plt.ylabel(“Metro Area”) plt.tight_layout() plt.savefig(‘output/salary_comparison_cities.png’) plt.show()</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>